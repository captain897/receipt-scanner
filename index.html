<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Receipt Scanner</title>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }
        .container { max-width: 100%; padding: 10px; }
        .camera-section { position: relative; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 10px; }
        #video { width: 100%; display: block; }
        #canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .controls { display: flex; gap: 10px; margin-bottom: 10px; }
        button { flex: 1; padding: 14px; font-size: 16px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; }
        .btn-primary { background: #007AFF; color: white; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .preview-section { display: none; background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .preview-section.active { display: block; }
        #preview-image { width: 100%; border-radius: 8px; margin-bottom: 10px; }
        .status { text-align: center; padding: 8px; font-size: 14px; color: #666; }
        .status.ready { color: #34c759; }
        .status.detecting { color: #007AFF; font-weight: bold; }
        .status.error { color: #ff3b30; }
        .file-input-section { margin-bottom: 10px; }
        .file-label { display: block; padding: 14px; background: #e0e0e0; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 600; }
        #file-input { display: none; }
        .captured-indicator { display: none; background: #34c759; color: white; padding: 12px; border-radius: 10px; text-align: center; font-weight: 600; margin-bottom: 10px; }
        .captured-indicator.show { display: block; }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 30px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div>Loading scanner...</div>
        </div>
        
        <div id="main-content" class="hidden">
            <div class="captured-indicator" id="captured-indicator">✓ Receipt Attached</div>
            
            <div class="camera-section" id="camera-section">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas-overlay"></canvas>
            </div>
            
            <div id="status" class="status">Initializing...</div>
            
            <div class="controls" id="camera-controls">
                <button id="capture-btn" class="btn-primary" disabled>Scan Receipt</button>
            </div>
            
            <div class="file-input-section">
                <label class="file-label" for="file-input">Choose File</label>
                <input type="file" id="file-input" accept="image/*">
            </div>
            
            <div class="preview-section" id="preview-section">
                <img id="preview-image" alt="Captured receipt">
                <div class="controls">
                    <button id="retake-btn" class="btn-secondary">Retake</button>
                    <button id="use-btn" class="btn-primary">Use Photo</button>
                </div>
            </div>
        </div>
    </div>
    
    <canvas id="process-canvas" style="display:none;"></canvas>
    
    <script src="https://cdn.jsdelivr.net/npm/jscanify@1.2.0/dist/jscanify.min.js"></script>
    <script type="text/javascript">
        var cvReady = false;
        var scanner = null;
        var stream = null;
        var capturedImageData = null;
        var detectionInterval = null;
        
        var video = document.getElementById('video');
        var canvasOverlay = document.getElementById('canvas-overlay');
        var captureBtn = document.getElementById('capture-btn');
        var fileInput = document.getElementById('file-input');
        var previewSection = document.getElementById('preview-section');
        var previewImage = document.getElementById('preview-image');
        var retakeBtn = document.getElementById('retake-btn');
        var useBtn = document.getElementById('use-btn');
        var statusEl = document.getElementById('status');
        var cameraSection = document.getElementById('camera-section');
        var capturedIndicator = document.getElementById('captured-indicator');
        var loadingEl = document.getElementById('loading');
        var mainContent = document.getElementById('main-content');
        
        // Load OpenCV
        var opencvScript = document.createElement('script');
        opencvScript.src = "https://docs.opencv.org/4.7.0/opencv.js";
        opencvScript.async = true;
        opencvScript.onload = function() {
            var checkCV = setInterval(function() {
                if (typeof cv !== 'undefined' && cv.Mat) {
                    clearInterval(checkCV);
                    clearTimeout(opencvTimeout);
                    onOpenCvReady();
                }
            }, 100);
        };
        document.head.appendChild(opencvScript);
        
        var opencvTimeout = setTimeout(function() {
            console.log("OpenCV timeout");
            cvReady = true;
            scanner = null;
            loadingEl.classList.add('hidden');
            mainContent.classList.remove('hidden');
            initCamera();
        }, 15000);
        
        function onOpenCvReady() {
            console.log("OpenCV ready");
            cvReady = true;
            try {
                scanner = new jscanify();
                console.log("Scanner initialized");
            } catch(e) {
                console.log("Scanner init failed", e);
                scanner = null;
            }
            loadingEl.classList.add('hidden');
            mainContent.classList.remove('hidden');
            initCamera();
        }
        
        // JotForm Widget Integration
        JFCustomWidget.subscribe("ready", function(data){
            JFCustomWidget.requestFrameResize({ height: 550 });
            
            JFCustomWidget.subscribe("submit", function(){
                var msg = {
                    valid: !!capturedImageData,
                    value: capturedImageData || ""
                };
                JFCustomWidget.sendSubmit(msg);
            });
        });
        
        function initCamera() {
            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
            }).then(function(s) {
                stream = s;
                video.srcObject = stream;
                video.onloadedmetadata = function() {
                    canvasOverlay.width = video.videoWidth;
                    canvasOverlay.height = video.videoHeight;
                    captureBtn.disabled = false;
                    statusEl.textContent = "Point at receipt";
                    statusEl.className = "status ready";
                    if (scanner) {
                        startDetection();
                    }
                };
            }).catch(function(e) {
                console.log("Camera error", e);
                statusEl.textContent = "Camera not available - use Choose File";
                statusEl.className = "status error";
                cameraSection.classList.add('hidden');
                document.getElementById('camera-controls').classList.add('hidden');
            });
        }
        
        function startDetection() {
            if (detectionInterval) clearInterval(detectionInterval);
            
            detectionInterval = setInterval(function() {
                if (!scanner || !video.videoWidth || video.paused) return;
                
                try {
                    var ctx = canvasOverlay.getContext('2d');
                    ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
                    
                    var resultCanvas = scanner.highlightPaper(video);
                    if (resultCanvas) {
                        ctx.drawImage(resultCanvas, 0, 0, canvasOverlay.width, canvasOverlay.height);
                        statusEl.textContent = "✓ Receipt detected - tap Scan Receipt";
                        statusEl.className = "status detecting";
                    } else {
                        statusEl.textContent = "Point at receipt";
                        statusEl.className = "status ready";
                    }
                } catch(e) {
                    // Silent fail
                }
            }, 150);
        }
        
        function stopDetection() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            var ctx = canvasOverlay.getContext('2d');
            if (ctx) ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        }
        
        function captureImage() {
            stopDetection();
            
            var canvas = document.getElementById('process-canvas');
            var resultCanvas = null;
            
            if (scanner) {
                try {
                    resultCanvas = scanner.extractPaper(video, 800, 1100);
                } catch(e) {
                    console.log("Extract failed", e);
                }
            }
            
            if (resultCanvas) {
                capturedImageData = resultCanvas.toDataURL('image/jpeg', 0.75);
            } else {
                var maxWidth = 800;
                var scale = Math.min(1, maxWidth / video.videoWidth);
                canvas.width = video.videoWidth * scale;
                canvas.height = video.videoHeight * scale;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                capturedImageData = canvas.toDataURL('image/jpeg', 0.75);
            }
            
            previewImage.src = capturedImageData;
            cameraSection.classList.add('hidden');
            document.getElementById('camera-controls').classList.add('hidden');
            previewSection.classList.add('active');
            statusEl.textContent = "Review your scan";
            statusEl.className = "status";
        }
        
        function handleFileSelect(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            stopDetection();
            
            var reader = new FileReader();
            reader.onload = function(event) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.getElementById('process-canvas');
                    var maxWidth = 800;
                    var scale = Math.min(1, maxWidth / img.width);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    if (scanner) {
                        try {
                            var extracted = scanner.extractPaper(canvas, 800, 1100);
                            if (extracted) {
                                capturedImageData = extracted.toDataURL('image/jpeg', 0.75);
                                previewImage.src = capturedImageData;
                                cameraSection.classList.add('hidden');
                                document.getElementById('camera-controls').classList.add('hidden');
                                previewSection.classList.add('active');
                                statusEl.textContent = "Review your scan";
                                return;
                            }
                        } catch(e) {
                            console.log("Extract from file failed", e);
                        }
                    }
                    
                    capturedImageData = canvas.toDataURL('image/jpeg', 0.75);
                    previewImage.src = capturedImageData;
                    cameraSection.classList.add('hidden');
                    document.getElementById('camera-controls').classList.add('hidden');
                    previewSection.classList.add('active');
                    statusEl.textContent = "Review your image";
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function retake() {
            capturedImageData = null;
            previewSection.classList.remove('active');
            cameraSection.classList.remove('hidden');
            document.getElementById('camera-controls').classList.remove('hidden');
            capturedIndicator.classList.remove('show');
            statusEl.textContent = "Point at receipt";
            statusEl.className = "status ready";
            fileInput.value = '';
            if (scanner) startDetection();
        }
        
        function usePhoto() {
            previewSection.classList.remove('active');
            cameraSection.classList.add('hidden');
            document.getElementById('camera-controls').classList.add('hidden');
            capturedIndicator.classList.add('show');
            statusEl.textContent = "Receipt ready - submit form";
            statusEl.className = "status ready";
            
            JFCustomWidget.sendData({ value: capturedImageData });
        }
        
        // Event listeners
        captureBtn.addEventListener('click', captureImage);
        fileInput.addEventListener('change', handleFileSelect);
        retakeBtn.addEventListener('click', retake);
        useBtn.addEventListener('click', usePhoto);
    </script>
</body>
</html>
